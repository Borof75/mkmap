<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Универсальная картография</title>
    <!-- Добавляем Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* Весь существующий CSS код остается без изменений */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background: rgba(20, 20, 20, 0.95);
            padding: 1rem 2rem;
            border-bottom: 1px solid #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 20;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4a86e8;
            text-shadow: 0 0 10px rgba(74, 134, 232, 0.7);
        }
        
        .date {
            font-size: 1rem;
            color: #666;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 400px;
            background: rgba(25, 25, 25, 0.95);
            padding: 1.5rem;
            border-right: 1px solid #333;
            overflow-y: auto;
            z-index: 10;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(40, 40, 40, 0.5);
            border-radius: 3px;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb {
            background: #4a86e8;
            border-radius: 3px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: 
                radial-gradient(circle at 20% 30%, #2a2a2a 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, #1a1a1a 0%, transparent 50%),
                #0a0a0a;
            cursor: grab;
        }
        
        .map-container:active {
            cursor: grabbing;
        }
        
        .map {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: 0 0;
            transition: transform 0.1s ease;
        }
        
        .planet {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s, filter 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 5px black;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            z-index: 5;
        }
        
        .planet:hover {
            transform: scale(1.1);
            filter: brightness(1.3);
        }
        
        .planet.selected {
            box-shadow: 0 0 25px 8px #4a86e8;
        }
        
        .planet.dragging {
            cursor: grabbing;
            opacity: 0.8;
        }
        
        .planet-label {
            position: absolute;
            bottom: -25px;
            text-align: center;
            font-size: 0.9rem;
            color: #aaa;
            white-space: nowrap;
        }
        
        .ship {
            position: absolute;
            width: 20px;
            height: 20px;
            transform-origin: center;
            transition: all 0.5s;
            z-index: 10;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* Шаттл - маленький круг */
        .ship.shuttle {
            background: #888888;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        
        /* Корвет - ромб */
        .ship.corvette {
            background: #44ff44;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            width: 16px;
            height: 16px;
        }
        
        /* Фрегат - шестиугольник */
        .ship.frigate {
            background: #4444ff;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }
        
        /* Лёгкий крейсер - восьмиугольник */
        .ship.light-cruiser {
            background: #ffaa00;
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
        }
        
        /* Крейсер - квадрат */
        .ship.cruiser {
            background: #ff4444;
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
        }
        
        /* Ударный корабль - звезда */
        .ship.assault {
            background: #ff00ff;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        
        /* Звёздный разрушитель - большой сложный корабль */
        .ship.destroyer {
            background: #aa00ff;
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
            width: 24px;
            height: 24px;
        }
        
        .ship.moving {
            animation: pulse 1.5s infinite alternate;
        }
        
        .ship.selected {
            filter: drop-shadow(0 0 8px currentColor);
        }
        
        .ship.damaged {
            opacity: 0.7;
            filter: brightness(0.8);
        }
        
        .ship.destroyed {
            opacity: 0.3;
            filter: grayscale(1);
            animation: none;
        }
        
        @keyframes pulse {
            from { 
                filter: drop-shadow(0 0 3px currentColor);
            }
            to { 
                filter: drop-shadow(0 0 10px currentColor);
            }
        }
        
        .route {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, transparent, #444, transparent);
            transform-origin: 0 0;
            z-index: 1;
        }
        
        .route::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(68, 68, 68, 0.3);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        button {
            background: #333;
            color: #ccc;
            border: 1px solid #444;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #444;
            border-color: #555;
        }
        
        button:disabled {
            background: #222;
            color: #666;
            border-color: #333;
            cursor: not-allowed;
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #4a86e8;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #333;
        }
        
        .planet-info {
            background: rgba(40, 40, 40, 0.7);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #333;
        }
        
        .planet-name {
            font-size: 1.3rem;
            color: #4a86e8;
            margin-bottom: 0.5rem;
        }
        
        .fleet-list {
            margin-top: 1rem;
        }
        
        .fleet-item {
            background: rgba(35, 35, 35, 0.7);
            padding: 0.8rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #888;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 0.5rem;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            color: #ccc;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4a86e8;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 0 30px rgba(74, 134, 232, 0.2);
            border: 1px solid #333;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #4a86e8;
        }
        
        .close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .close:hover {
            color: #888;
        }
        
        .zoom-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(30, 30, 30, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #888;
            z-index: 20;
            border: 1px solid #333;
        }
        
        .help-tooltip {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #666;
            z-index: 20;
            border: 1px solid #333;
        }
        
        .travel-time-controls {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(40, 40, 40, 0.7);
            border-radius: 6px;
            border: 1px solid #333;
        }
        
        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .time-input {
            width: 80px;
            text-align: center;
        }
        
        .ship-progress {
            width: 100%;
            height: 6px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
            border: 1px solid #333;
        }
        
        .ship-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4a86e8, #6cb4ee);
            width: 0%;
            transition: width 0.5s;
        }
        
        .travel-info {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #777;
        }
        
        .context-menu {
            position: absolute;
            background: rgba(35, 35, 35, 0.95);
            border: 1px solid #444;
            border-radius: 6px;
            padding: 0.5rem;
            z-index: 100;
            display: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .context-menu button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 0.3rem;
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            color: #ccc;
        }
        
        .context-menu button:hover {
            background: rgba(60, 60, 60, 0.7);
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 40, 40, 0.9);
            padding: 1rem 2rem;
            border-radius: 6px;
            box-shadow: 0 0 20px rgba(74, 134, 232, 0.2);
            z-index: 1000;
            display: none;
            border: 1px solid #444;
            color: #ccc;
            max-width: 80%;
            text-align: center;
        }
        
        .notification.warning {
            background: rgba(200, 100, 0, 0.9);
            border-color: #ff8800;
        }
        
        .notification.danger {
            background: rgba(200, 0, 0, 0.9);
            border-color: #ff4444;
        }
        
        .notification.success {
            background: rgba(0, 150, 0, 0.9);
            border-color: #44ff44;
        }
        
        .time-presets {
            display: flex;
            gap: 5px;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        
        .time-preset {
            padding: 4px 8px;
            font-size: 0.8rem;
            background: #333;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .time-preset:hover {
            background: #444;
        }
        
        .ship-type-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .ship-type-indicator.shuttle {
            background: #888888;
            border-radius: 50%;
        }
        
        .ship-type-indicator.corvette {
            background: #44ff44;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        
        .ship-type-indicator.frigate {
            background: #4444ff;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }
        
        .ship-type-indicator.light-cruiser {
            background: #ffaa00;
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
        }
        
        .ship-type-indicator.cruiser {
            background: #ff4444;
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
        }
        
        .ship-type-indicator.assault {
            background: #ff00ff;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        
        .ship-type-indicator.destroyer {
            background: #aa00ff;
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
        }
        
        .event-log {
            margin-top: 1rem;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.8rem;
        }
        
        .event-item {
            margin-bottom: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            background: rgba(50, 50, 50, 0.5);
        }
        
        .event-item.warning {
            background: rgba(200, 100, 0, 0.3);
            border-left: 3px solid #ff8800;
        }
        
        .event-item.danger {
            background: rgba(200, 0, 0, 0.3);
            border-left: 3px solid #ff4444;
        }
        
        .event-item.info {
            background: rgba(0, 100, 200, 0.3);
            border-left: 3px solid #4a86e8;
        }
        
        .event-item.success {
            background: rgba(0, 150, 0, 0.3);
            border-left: 3px solid #44ff44;
        }
        
        .tab-container {
            margin-top: 1rem;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border: 1px solid #444;
            border-radius: 6px;
            background: #2a2a2a;
            color: #ccc;
            font-size: 0.9rem;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .tab:hover {
            background: #333;
            border-color: #555;
        }
        
        .tab.active {
            background: #4a86e8;
            border-color: #6cb4ee;
            color: white;
            box-shadow: 0 0 15px rgba(74, 134, 232, 0.4);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .planet-coords {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
        }
        
        .ship-image-container {
            margin: 1rem 0;
            text-align: center;
        }
        
        .ship-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            border: 1px solid #444;
            background: rgba(40, 40, 40, 0.8);
            padding: 5px;
        }
        
        .ship-image-placeholder {
            width: 100%;
            height: 150px;
            background: rgba(40, 40, 40, 0.8);
            border: 2px dashed #444;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
        }
        
        .image-upload-btn {
            margin-top: 0.5rem;
            width: 100%;
        }
        
        .ship-details {
            background: rgba(40, 40, 40, 0.7);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border: 1px solid #333;
        }
        
        .ship-owner {
            font-size: 1rem;
            color: #4a86e8;
            margin-bottom: 0.5rem;
        }
        
        .ship-description {
            font-size: 0.9rem;
            color: #aaa;
            line-height: 1.4;
        }
        
        .file-input {
            display: none;
        }
        
        .ship-info-extended {
            margin-top: 1rem;
        }
        
        .ship-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            background: rgba(35, 35, 35, 0.7);
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #333;
            font-size: 0.9rem;
        }
        
        .stat-label {
            color: #888;
            font-size: 0.8rem;
        }
        
        .stat-value {
            color: #4a86e8;
            font-weight: bold;
        }
        
        .health-bar {
            width: 100%;
            height: 8px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 4px;
            margin-top: 0.3rem;
            overflow: hidden;
            border: 1px solid #333;
        }
        
        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffaa00, #44ff44);
            width: 100%;
            transition: width 0.5s;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            flex: 1;
            min-width: 80px;
            padding: 0.8rem 0.5rem;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .quick-action-btn:hover {
            background: #333;
            border-color: #555;
        }
        
        .quick-action-btn.active {
            background: #4a86e8;
            border-color: #6cb4ee;
            color: white;
            box-shadow: 0 0 15px rgba(74, 134, 232, 0.4);
        }
        
        .quick-action-btn.primary {
            background: #4a86e8;
            border-color: #6cb4ee;
            color: white;
        }
        
        .quick-action-btn.primary:hover {
            background: #5a96f8;
            box-shadow: 0 0 10px rgba(74, 134, 232, 0.3);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .content-title {
            font-size: 1.3rem;
            color: #4a86e8;
            font-weight: bold;
        }
        
        .success-chance {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(40, 40, 40, 0.7);
            border-radius: 6px;
            border: 1px solid #333;
        }
        
        .chance-value {
            font-size: 1.5rem;
            color: #4a86e8;
            font-weight: bold;
            text-align: center;
            margin: 0.5rem 0;
        }
        
        .chance-good {
            color: #44ff44;
        }
        
        .chance-medium {
            color: #ffaa00;
        }
        
        .chance-low {
            color: #ff4444;
        }
        
        /* Стили для кнопок Firebase */
        .firebase-controls {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .firebase-btn {
            flex: 1;
            background: #4a86e8;
            color: white;
            border: 1px solid #6cb4ee;
        }
        
        .firebase-btn:hover {
            background: #5a96f8;
            box-shadow: 0 0 10px rgba(74, 134, 232, 0.3);
        }
        
        .firebase-btn.save {
            background: #44aa44;
            border-color: #66cc66;
        }
        
        .firebase-btn.save:hover {
            background: #55bb55;
        }
        
        .firebase-btn.load {
            background: #e69138;
            border-color: #f1c232;
        }
        
        .firebase-btn.load:hover {
            background: #f6b26b;
        }

        .firebase-btn.auto-save {
            background: #a64d79;
            border-color: #c27ba0;
        }

        .firebase-btn.auto-save:hover {
            background: #b5739d;
        }

        .firebase-btn.auto-save.disabled {
            background: #666;
            border-color: #888;
        }

        .auto-save-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(30, 30, 30, 0.9);
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #44ff44;
            z-index: 20;
            border: 1px solid #44ff44;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">УНИВЕРСАЛЬНАЯ КАРТОГРАФИЯ</div>
                <div class="date">21 октября 2023 г.</div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-content">
                    <!-- Быстрые действия -->
                    <div class="quick-actions">
                        <button class="quick-action-btn primary active" data-tab="system">
                            <div>🌌</div>
                            <div>Система</div>
                        </button>
                        <button class="quick-action-btn" data-tab="planets">
                            <div>🪐</div>
                            <div>Планеты</div>
                        </button>
                        <button class="quick-action-btn" data-tab="ships">
                            <div>🚀</div>
                            <div>Корабли</div>
                        </button>
                        <button class="quick-action-btn" data-tab="creation">
                            <div>➕</div>
                            <div>Создать</div>
                        </button>
                    </div>
                    
                    <!-- Кнопки управления Firebase -->
                    <div class="firebase-controls">
                        <button class="firebase-btn save" id="save-to-firebase">Сохранить в Firebase</button>
                        <button class="firebase-btn load" id="load-from-firebase">Загрузить из Firebase</button>
                        <button class="firebase-btn auto-save" id="toggle-auto-save">Автосохранение: ВКЛ</button>
                    </div>
                    
                    <!-- Содержимое вкладок -->
                    <div class="tab-content active" id="system-tab">
                        <div class="content-header">
                            <div class="content-title">СИСТЕМНАЯ ИНФОРМАЦИЯ</div>
                        </div>
                        
                        <div class="section">
                            <div class="planet-info">
                                <div class="planet-name" id="selected-planet-name">Выберите планету</div>
                                <div id="selected-planet-desc">Нажмите на планету на карте для просмотра информации</div>
                                <div class="planet-coords" id="planet-coords"></div>
                            </div>
                            
                            <div class="fleet-list">
                                <div class="section-title">ФЛОТ НА ПЛАНЕТЕ</div>
                                <div id="planet-fleet-list">
                                    <div class="fleet-item">Нет кораблей</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">ВЫБРАННЫЙ КОРАБЛЬ</div>
                            <div class="ship-info">
                                <div class="ship-name" id="selected-ship-name">Корабль не выбран</div>
                                <div id="selected-ship-info">Нажмите на корабль на карте для выбора</div>
                                
                                <!-- Расширенная информация о корабле -->
                                <div class="ship-info-extended" id="ship-info-extended" style="display: none;">
                                    <div class="ship-image-container">
                                        <div class="ship-image-placeholder" id="ship-image-placeholder">
                                            Изображение корабля не загружено
                                        </div>
                                        <img id="ship-image" class="ship-image" style="display: none;">
                                        <button class="image-upload-btn" id="upload-ship-image">Загрузить изображение</button>
                                        <input type="file" id="ship-image-input" class="file-input" accept="image/*">
                                    </div>
                                    
                                    <div class="ship-details">
                                        <div class="ship-owner">Владелец: <span id="ship-owner">Не указан</span></div>
                                        <div class="ship-description" id="ship-description-text">
                                            Описание корабля не добавлено
                                        </div>
                                        <button id="edit-ship-details" style="margin-top: 1rem; width: 100%;">Редактировать описание</button>
                                    </div>
                                    
                                    <div class="ship-stats">
                                        <div class="stat-item">
                                            <div class="stat-label">Тип</div>
                                            <div class="stat-value" id="ship-stat-type">-</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Статус</div>
                                            <div class="stat-value" id="ship-stat-status">-</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Здоровье</div>
                                            <div class="stat-value" id="ship-stat-health">-</div>
                                            <div class="health-bar">
                                                <div class="health-bar-fill" id="ship-health-bar"></div>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Бонус успеха</div>
                                            <div class="stat-value" id="ship-stat-bonus">-</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Расположение</div>
                                            <div class="stat-value" id="ship-stat-location">-</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Скорость</div>
                                            <div class="stat-value" id="ship-stat-speed">-</div>
                                        </div>
                                    </div>
                                    
                                    <div class="success-chance" id="success-chance" style="display: none;">
                                        <div class="section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">ШАНС УСПЕХА МИССИИ</div>
                                        <div class="chance-value" id="chance-value">0%</div>
                                        <div style="text-align: center; color: #888; font-size: 0.9rem;">
                                            Базовый шанс: 60% + бонус корабля
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="destination-select" id="destination-controls" style="display: none; margin-top: 1rem;">
                                    <select id="destination-select">
                                        <option value="">Выберите пункт назначения</option>
                                    </select>
                                    <button id="send-ship-btn" style="margin-top: 0.5rem; width: 100%;">Отправить корабль</button>
                                </div>
                                
                                <div class="travel-time-controls" id="travel-time-controls" style="display: none;">
                                    <div class="section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">ВРЕМЯ ПУТИ</div>
                                    
                                    <div class="time-input-group">
                                        <input type="number" id="travel-hours" class="time-input" min="0" value="0" max="24">
                                        <span>часов</span>
                                    </div>
                                    
                                    <div class="time-input-group">
                                        <input type="number" id="travel-minutes" class="time-input" min="0" value="1" max="59">
                                        <span>минут</span>
                                    </div>
                                    
                                    <div class="time-input-group">
                                        <input type="number" id="travel-seconds" class="time-input" min="0" value="0" max="59">
                                        <span>секунд</span>
                                    </div>
                                    
                                    <div class="time-presets">
                                        <div class="time-preset" data-seconds="5">5 сек</div>
                                        <div class="time-preset" data-seconds="30">30 сек</div>
                                        <div class="time-preset" data-minutes="1">1 мин</div>
                                        <div class="time-preset" data-minutes="5">5 мин</div>
                                        <div class="time-preset" data-minutes="30">30 мин</div>
                                        <div class="time-preset" data-hours="1">1 час</div>
                                    </div>
                                    
                                    <div class="ship-progress">
                                        <div class="ship-progress-bar" id="ship-progress-bar"></div>
                                    </div>
                                    
                                    <div class="travel-info" id="travel-info"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">ЖУРНАЛ СОБЫТИЙ</div>
                            <div class="event-log" id="event-log">
                                <div class="event-item info">Система инициализирована</div>
                                <div class="event-item">Карта загружена</div>
                                <div class="event-item">Готов к работе</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Вкладка планет -->
                    <div class="tab-content" id="planets-tab">
                        <div class="content-header">
                            <div class="content-title">УПРАВЛЕНИЕ ПЛАНЕТАМИ</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">СПИСОК ПЛАНЕТ</div>
                            <div id="planets-list">
                                <!-- Список планет будет генерироваться динамически -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Вкладка кораблей -->
                    <div class="tab-content" id="ships-tab">
                        <div class="content-header">
                            <div class="content-title">УПРАВЛЕНИЕ ФЛОТОМ</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">СПИСОК КОРАБЛЕЙ</div>
                            <div id="ships-list">
                                <!-- Список кораблей будет генерироваться динамически -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Вкладка создания -->
                    <div class="tab-content" id="creation-tab">
                        <div class="content-header">
                            <div class="content-title">СОЗДАНИЕ ОБЪЕКТОВ</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">СОЗДАТЬ ПЛАНЕТУ</div>
                            <div class="form-group">
                                <label for="new-planet-name">Название планеты</label>
                                <input type="text" id="new-planet-name" placeholder="Введите название">
                            </div>
                            <div class="form-group">
                                <label for="new-planet-desc">Описание</label>
                                <textarea id="new-planet-desc" placeholder="Введите описание планеты"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="new-planet-color">Цвет</label>
                                <input type="color" id="new-planet-color" value="#4a86e8">
                            </div>
                            <div class="form-group">
                                <label for="new-planet-size">Размер (20-100)</label>
                                <input type="number" id="new-planet-size" min="20" max="100" value="40">
                            </div>
                            <button id="create-planet-btn">Создать планету</button>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">СОЗДАТЬ КОРАБЛЬ</div>
                            <div class="form-group">
                                <label for="new-ship-name">Название корабля</label>
                                <input type="text" id="new-ship-name" placeholder="Введите название">
                            </div>
                            <div class="form-group">
                                <label for="new-ship-type">Тип корабля</label>
                                <select id="new-ship-type">
                                    <option value="shuttle">Шаттл</option>
                                    <option value="corvette">Корвет</option>
                                    <option value="frigate">Фрегат</option>
                                    <option value="light-cruiser">Лёгкий крейсер</option>
                                    <option value="cruiser">Крейсер</option>
                                    <option value="assault">Ударный корабль</option>
                                    <option value="destroyer">Звёздный разрушитель</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-ship-location">Местоположение</label>
                                <select id="new-ship-location">
                                    <option value="">Выберите планету</option>
                                </select>
                            </div>
                            <button id="create-ship-btn">Создать корабль</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div class="map" id="map">
                    <!-- Планеты и корабли будут добавлены динамически -->
                </div>
                
                <div class="zoom-indicator">
                    Масштаб: <span id="zoom-level">100%</span>
                </div>
                
                <div class="help-tooltip">
                    Управление: колесо мыши - масштаб, ПКМ - контекстное меню
                </div>

                <div class="auto-save-indicator" id="auto-save-indicator">
                    Автосохранение...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Контекстное меню -->
    <div class="context-menu" id="context-menu">
        <button id="context-create-planet">Создать планету здесь</button>
        <button id="context-create-ship">Создать корабль здесь</button>
        <button id="context-center-view">Центрировать вид</button>
        <button id="context-reset-zoom">Сбросить масштаб</button>
    </div>
    
    <!-- Модальное окно для редактирования корабля -->
    <div class="modal" id="edit-ship-modal">
        <div class="modal-content">
            <span class="close" id="close-edit-ship-modal">&times;</span>
            <div class="modal-title">РЕДАКТИРОВАНИЕ КОРАБЛЯ</div>
            
            <div class="form-group">
                <label for="edit-ship-name">Название корабля</label>
                <input type="text" id="edit-ship-name">
            </div>
            
            <div class="form-group">
                <label for="edit-ship-owner">Владелец</label>
                <input type="text" id="edit-ship-owner" placeholder="Введите имя владельца">
            </div>
            
            <div class="form-group">
                <label for="edit-ship-description">Описание</label>
                <textarea id="edit-ship-description" rows="4" placeholder="Введите описание корабля"></textarea>
            </div>
            
            <div class="form-group">
                <label for="edit-ship-health">Здоровье (0-100)</label>
                <input type="number" id="edit-ship-health" min="0" max="100" value="100">
            </div>
            
            <button id="save-ship-details" style="width: 100%; margin-top: 1rem;">Сохранить изменения</button>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div class="notification" id="notification"></div>
    
    <script>
        // 🔥 ИСПРАВЛЕННАЯ КОНФИГУРАЦИЯ FIREBASE 🔥
        const firebaseConfig = {
            apiKey: "AIzaSyCQXpQcW3aEKyQejbby8Z4mBbxCyQuDgWA",
            authDomain: "mkmap52.firebaseapp.com",
            databaseURL: "https://mkmap52-default-rtdb.firebaseio.com",
            projectId: "mkmap52",
            storageBucket: "mkmap52.firebasestorage.app",
            messagingSenderId: "1074843521487",
            appId: "1:1074843521487:web:42ec461673aea62ea2c2ba"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Основные переменные приложения
        let planets = [];
        let ships = [];
        let selectedPlanet = null;
        let selectedShip = null;
        let mapScale = 1;
        let mapOffset = { x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let isMapDragging = false;
        let mapDragStart = { x: 0, y: 0 };
        let shipTravelTimers = {};
        let contextMenu = null;
        let currentTab = 'system';
        let autoSaveInterval = null;
        let isSaving = false;
        let autoSaveEnabled = true;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            setupAutoSave();
            loadFromFirebase();
        });

        // Функция настройки автосохранения
        function setupAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            if (autoSaveEnabled) {
                // Автосохранение каждые 30 секунд
                autoSaveInterval = setInterval(() => {
                    if (!isSaving) {
                        autoSaveToFirebase();
                    }
                }, 30000);

                // Также сохраняем при закрытии/обновлении страницы
                window.addEventListener('beforeunload', () => {
                    if (!isSaving) {
                        manualSaveToFirebase();
                    }
                });

                document.getElementById('toggle-auto-save').textContent = 'Автосохранение: ВКЛ';
                document.getElementById('toggle-auto-save').classList.remove('disabled');
            } else {
                document.getElementById('toggle-auto-save').textContent = 'Автосохранение: ВЫКЛ';
                document.getElementById('toggle-auto-save').classList.add('disabled');
            }
        }

        // Функция автосохранения
        function autoSaveToFirebase() {
            if (isSaving || !autoSaveEnabled) return;
            
            isSaving = true;
            const data = {
                planets: planets,
                ships: ships,
                lastUpdated: Date.now(),
                autoSave: true
            };
            
            // Показываем индикатор автосохранения
            const indicator = document.getElementById('auto-save-indicator');
            indicator.style.display = 'block';
            
            database.ref('universeMap').set(data)
                .then(() => {
                    console.log('Автосохранение выполнено успешно');
                    // Мигаем индикатором
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 1000);
                })
                .catch((error) => {
                    console.error('Ошибка автосохранения в Firebase:', error);
                    indicator.style.display = 'none';
                })
                .finally(() => {
                    isSaving = false;
                });
        }

        // Функция ручного сохранения
        function manualSaveToFirebase() {
            const data = {
                planets: planets,
                ships: ships,
                lastUpdated: Date.now(),
                manualSave: true
            };
            
            // Используем синхронный запрос для надежности
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', `https://mkmap52-default-rtdb.firebaseio.com/universeMap.json?auth=${firebaseConfig.apiKey}`, false);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(data));
            
            return xhr.status === 200;
        }

        function initializeApp() {
            // Создаем контекстное меню
            contextMenu = document.getElementById('context-menu');
            
            // Создаем начальные планеты, если нет данных в Firebase
            if (planets.length === 0) {
                createInitialPlanets();
            }
            
            // Создаем начальные корабли, если нет данных в Firebase
            if (ships.length === 0) {
                createInitialShips();
            }
            
            // Обновляем интерфейс
            updatePlanetsList();
            updateShipsList();
            updateLocationSelects();
            
            // Показываем системную вкладку по умолчанию
            showTab('system');
        }

        function createInitialPlanets() {
            planets = [
                {
                    id: 1,
                    name: "Терра",
                    description: "Родная планета человечества, центр галактической империи.",
                    x: 400,
                    y: 300,
                    size: 50,
                    color: "#4a86e8"
                },
                {
                    id: 2,
                    name: "Марс",
                    description: "Красная планета, колонизирована в 22 веке. Крупный промышленный центр.",
                    x: 600,
                    y: 200,
                    size: 40,
                    color: "#cc4125"
                },
                {
                    id: 3,
                    name: "Центавра Прайм",
                    description: "Первая колония за пределами Солнечной системы. Богата ресурсами.",
                    x: 300,
                    y: 500,
                    size: 45,
                    color: "#6aa84f"
                },
                {
                    id: 4,
                    name: "Новая Венера",
                    description: "Терраформированная планета с тропическим климатом. Курортный мир.",
                    x: 700,
                    y: 400,
                    size: 42,
                    color: "#e69138"
                },
                {
                    id: 5,
                    name: "Титан-6",
                    description: "Ледяной мир с подповерхностным океаном. Научная база.",
                    x: 200,
                    y: 350,
                    size: 35,
                    color: "#a64d79"
                },
                {
                    id: 6,
                    name: "Кибертрон",
                    description: "Планета-крепость с развитой оборонной промышленностью.",
                    x: 500,
                    y: 600,
                    size: 48,
                    color: "#666666"
                }
            ];
            
            renderPlanets();
        }

        function createInitialShips() {
            ships = [
                {
                    id: 1,
                    name: "Искатель-1",
                    type: "shuttle",
                    location: 1,
                    x: 400,
                    y: 300,
                    owner: "Галактическая Федерация",
                    description: "Многоцелевой исследовательский шаттл. Оснащен современным сканирующим оборудованием.",
                    health: 100,
                    status: "docked"
                },
                {
                    id: 2,
                    name: "Молот",
                    type: "corvette",
                    location: 2,
                    x: 600,
                    y: 200,
                    owner: "Корпорация 'Орион'",
                    description: "Быстрый патрульный корабль. Идеален для перехвата контрабандистов.",
                    health: 85,
                    status: "docked"
                },
                {
                    id: 3,
                    name: "Непобедимый",
                    type: "frigate",
                    location: 3,
                    x: 300,
                    y: 500,
                    owner: "Военный флот Федерации",
                    description: "Универсальный фрегат с мощным вооружением. Участвовал в 15 боевых операциях.",
                    health: 100,
                    status: "docked"
                },
                {
                    id: 4,
                    name: "Буревестник",
                    type: "light-cruiser",
                    location: 4,
                    x: 700,
                    y: 400,
                    owner: "Исследовательский корпус",
                    description: "Крейсер дальнего радиуса действия. Совершил 7 экспедиций в неизведанные сектора.",
                    health: 75,
                    status: "docked"
                },
                {
                    id: 5,
                    name: "Грозный",
                    type: "cruiser",
                    location: 5,
                    x: 200,
                    y: 350,
                    owner: "Военный флот Федерации",
                    description: "Тяжелый крейсер класса 'Громовержец'. Главный корабль 7-го флота.",
                    health: 90,
                    status: "docked"
                },
                {
                    id: 6,
                    name: "Аннигилятор",
                    type: "assault",
                    location: 6,
                    x: 500,
                    y: 600,
                    owner: "Ударные силы Федерации",
                    description: "Специализированный ударный корабль. Оснащен экспериментальным оружием.",
                    health: 100,
                    status: "docked"
                },
                {
                    id: 7,
                    name: "Император",
                    type: "destroyer",
                    location: 1,
                    x: 400,
                    y: 300,
                    owner: "Флагманский флот",
                    description: "Звёздный разрушитель класса 'Император'. Крупнейший корабль в этом секторе.",
                    health: 100,
                    status: "docked"
                }
            ];
            
            renderShips();
        }

        // ... (все остальные функции остаются без изменений, за исключением функций saveToFirebase и loadFromFirebase)

        function saveToFirebase() {
            if (isSaving) {
                showNotification('Идет сохранение, подождите...', 'warning');
                return;
            }
            
            isSaving = true;
            const data = {
                planets: planets,
                ships: ships,
                lastUpdated: Date.now()
            };
            
            database.ref('universeMap').set(data)
                .then(() => {
                    showNotification('Данные успешно сохранены в Firebase!', 'success');
                    addEvent('Данные сохранены в облаке', 'success');
                })
                .catch((error) => {
                    console.error('Ошибка сохранения в Firebase:', error);
                    showNotification('Ошибка сохранения в Firebase: ' + error.message, 'danger');
                    addEvent('Ошибка сохранения данных в облаке', 'danger');
                })
                .finally(() => {
                    isSaving = false;
                });
        }

        function loadFromFirebase() {
            database.ref('universeMap').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        planets = data.planets || [];
                        ships = data.ships || [];
                        
                        renderPlanets();
                        renderShips();
                        updatePlanetsList();
                        updateShipsList();
                        updateLocationSelects();
                        
                        showNotification('Данные успешно загружены из Firebase!', 'success');
                        addEvent('Данные загружены из облака', 'success');
                        
                        // Восстанавливаем таймеры путешествий
                        restoreTravelTimers();
                        
                        // Показываем информацию о последнем сохранении
                        if (data.lastUpdated) {
                            const lastSave = new Date(data.lastUpdated).toLocaleString();
                            addEvent(`Данные загружены (последнее сохранение: ${lastSave})`, 'info');
                        }
                    } else {
                        showNotification('В Firebase нет сохраненных данных. Созданы начальные данные.', 'warning');
                        if (planets.length === 0) createInitialPlanets();
                        if (ships.length === 0) createInitialShips();
                    }
                })
                .catch((error) => {
                    console.error('Ошибка загрузки из Firebase:', error);
                    showNotification('Ошибка загрузки из Firebase: ' + error.message, 'danger');
                    addEvent('Ошибка загрузки данных из облака', 'danger');
                    
                    if (planets.length === 0) createInitialPlanets();
                    if (ships.length === 0) createInitialShips();
                });
        }

        function setupEventListeners() {
            // ... (все существующие обработчики событий)

            // Добавляем обработчик для кнопки автосохранения
            document.getElementById('toggle-auto-save').addEventListener('click', () => {
                autoSaveEnabled = !autoSaveEnabled;
                setupAutoSave();
                
                if (autoSaveEnabled) {
                    showNotification('Автосохранение включено', 'success');
                    addEvent('Автосохранение включено', 'success');
                } else {
                    showNotification('Автосохранение отключено', 'warning');
                    addEvent('Автосохранение отключено', 'warning');
                }
            });

            // ... (остальные обработчики событий)
        }

        // Остальные функции (renderPlanets, renderShips, selectPlanet, selectShip, и т.д.) остаются без изменений
        // ... (весь остальной код JavaScript)

    </script>
</body>
</html>
